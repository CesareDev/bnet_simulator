\documentclass{article}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{amsmath}
\usepackage{geometry}

\geometry{a4paper, margin=1in}

\begin{document}

\title{Channel Class Pseudocode for Beacon Network Simulator}
\author{Beacon Network Simulator}
\date{\today}
\maketitle

\section{Channel Class}

\begin{algorithm}
\caption{Channel Initialization}
\begin{algorithmic}[1]
\Procedure{Initialize}{$metrics$}
    \State $active\_transmissions \gets \emptyset$ \Comment{List of (beacon, start\_time, end\_time)}
    \State $metrics \gets metrics$
    \State $buoys \gets \emptyset$
    \State $seen\_attempts \gets \emptyset$ \Comment{Set of (receiver\_id, sender\_id, timestamp)}
\EndProcedure

\Procedure{SetBuoys}{$buoys$}
    \State $this.buoys \gets buoys$
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Channel Update}
\begin{algorithmic}[1]
\Procedure{Update}{$sim\_time$}
    \State $active\_transmissions \gets \{(b, start, end) \in active\_transmissions \mid end > sim\_time\}$ \Comment{Remove expired transmissions}
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Channel Broadcast}
\begin{algorithmic}[1]
\Procedure{Broadcast}{$beacon, sim\_time$}
    \If{$metrics \neq null$}
        \State $metrics.log\_sent()$
    \EndIf
    
    \State $transmission\_time \gets beacon.size\_bits() / BIT\_RATE$
    \State $new\_end\_time \gets sim\_time + transmission\_time$
    
    \ForAll{$(existing, start, end) \in active\_transmissions$}
        \If{$beacon.sender\_id = existing.sender\_id$}
            \State \textbf{continue} \Comment{Skip checking same sender}
        \EndIf
        
        \State $time\_overlap \gets (sim\_time \leq end) \land (start \leq new\_end\_time)$ \Comment{Check temporal overlap}
        
        \If{$time\_overlap \land \text{InRange}(beacon.position, existing.position)$}
            \State $log\_error($"Collision detected"$)$
            \If{$metrics \neq null$}
                \State $metrics.log\_collision()$
            \EndIf
            \State \Return $false$ \Comment{Collision occurred}
        \EndIf
    \EndFor
    
    \State $active\_transmissions.append((beacon, sim\_time, new\_end\_time))$
    \State $log\_info($"Broadcasting beacon"$)$
    
    \State $receivers\_in\_range \gets \{buoy \in buoys \mid buoy.id \neq beacon.sender\_id \land \text{InRange}(beacon.position, buoy.position)\}$
    \State $n\_receivers \gets |receivers\_in\_range|$
    
    \If{$metrics \neq null$}
        \State $metrics.log\_potentially\_sent(beacon.sender\_id, n\_receivers)$
    \EndIf
    
    \State \Return $true$
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Channel Is Busy}
\begin{algorithmic}[1]
\Procedure{IsBusy}{$position, sim\_time$}
    \ForAll{$(beacon, start, end) \in active\_transmissions$}
        \If{$start \leq sim\_time \leq end \land \text{InRange}(position, beacon.position)$}
            \State \Return $true$
        \EndIf
    \EndFor
    \State \Return $false$
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Channel Receive All}
\begin{algorithmic}[1]
\Procedure{ReceiveAll}{$receiver\_id, receiver\_position, sim\_time$}
    \State $received \gets \emptyset$
    
    \ForAll{$(beacon, start, end) \in active\_transmissions$}
        \If{$beacon.sender\_id = receiver\_id$}
            \State \textbf{continue} \Comment{Skip beacons from self}
        \EndIf
        
        \State $key \gets (receiver\_id, beacon.sender\_id, beacon.timestamp)$
        \If{$key \in seen\_attempts$}
            \State \textbf{continue} \Comment{Already processed this beacon}
        \EndIf
        
        \State $distance \gets \text{EuclideanDistance}(receiver\_position, beacon.position)$
        
        \If{$IDEAL\_CHANNEL$}
            \If{$distance > COMMUNICATION\_RANGE\_HIGH\_PROB$}
                \State \textbf{continue} \Comment{Out of range}
            \EndIf
            
            \State $propagation\_delay \gets distance / SPEED\_OF\_LIGHT$
            \State $arrival\_time \gets start + propagation\_delay$
            
            \If{$sim\_time < arrival\_time$}
                \State \textbf{continue} \Comment{Not yet arrived}
            \EndIf
            
            \State $seen\_attempts.add(key)$
            \State $received.append(beacon)$
        \Else
            \If{$distance > COMMUNICATION\_RANGE\_MAX$}
                \State \textbf{continue} \Comment{Out of range}
            \EndIf
            
            \State $propagation\_delay \gets distance / SPEED\_OF\_LIGHT$
            \State $arrival\_time \gets start + propagation\_delay$
            
            \If{$sim\_time < arrival\_time$}
                \State \textbf{continue} \Comment{Not yet arrived}
            \EndIf
            
            \State $seen\_attempts.add(key)$
            
            \If{$distance \leq COMMUNICATION\_RANGE\_HIGH\_PROB$}
                \If{$random() < DELIVERY\_PROB\_HIGH$}
                    \State $received.append(beacon)$
                \ElsIf{$metrics \neq null$}
                    \State $metrics.log\_lost()$
                \EndIf
            \ElsIf{$distance \leq COMMUNICATION\_RANGE\_MAX$}
                \If{$random() < DELIVERY\_PROB\_LOW$}
                    \State $received.append(beacon)$
                \Else
                    \State $log\_error($"Packet lost"$)$
                    \If{$metrics \neq null$}
                        \State $metrics.log\_lost()$
                    \EndIf
                \EndIf
            \EndIf
        \EndIf
    \EndFor
    
    \If{$|received| \leq 1$}
        \If{$metrics \neq null \land |received| = 1$}
            \State $metrics.log\_received(received[0].sender\_id, received[0].timestamp, sim\_time, receiver\_id)$
            \State $metrics.log\_actually\_received(received[0].sender\_id)$
        \EndIf
        \State \Return $received$
    \Else
        \State $log\_error($"Collision at receiver"$)$
        \If{$metrics \neq null$}
            \ForAll{$beacon \in received$}
                \State $metrics.log\_collision()$
            \EndFor
        \EndIf
        \State \Return $\emptyset$ \Comment{All beacons lost in collision}
    \EndIf
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}
\caption{Channel In Range}
\begin{algorithmic}[1]
\Procedure{InRange}{$pos1, pos2$}
    \State $dx \gets pos1.x - pos2.x$
    \State $dy \gets pos1.y - pos2.y$
    \State $distance \gets \sqrt{dx^2 + dy^2}$
    
    \If{$IDEAL\_CHANNEL$}
        \State \Return $distance \leq COMMUNICATION\_RANGE\_HIGH\_PROB$
    \Else
        \State \Return $distance \leq COMMUNICATION\_RANGE\_MAX$
    \EndIf
\EndProcedure
\end{algorithmic}
\end{algorithm}

\end{document}